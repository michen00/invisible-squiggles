# Data Model: Testing Infrastructure

**Date**: 2025-01-27
**Feature**: Comprehensive Testing Infrastructure
**Phase**: 1 - Design

## Test Structure Entities

### Test Suite

**Description**: Collection of related tests organized by type and functionality

**Attributes**:

- `type`: "unit" | "integration" | "e2e"
- `name`: string (descriptive name)
- `filePath`: string (relative path from `src/test/`)
- `testCases`: TestCase[]

**Relationships**:

- Contains multiple TestCase entities
- Belongs to TestType category
- Generates TestReport

**Validation Rules**:

- Must have at least one test case
- File path must follow naming convention: `*.test.ts`
- Type must be one of: unit, integration, e2e

---

### Test Case

**Description**: Individual test function that verifies specific behavior

**Attributes**:

- `name`: string (test description)
- `type`: "unit" | "integration" | "e2e"
- `function`: string (test function name)
- `setup`: SetupStep[] (optional)
- `assertions`: Assertion[]
- `teardown`: TeardownStep[] (optional)

**Relationships**:

- Belongs to TestSuite
- Executes against TestTarget
- Produces TestResult

**Validation Rules**:

- Must have at least one assertion
- Name must be descriptive and unique within suite
- Must follow Mocha test structure

---

### Test Target

**Description**: Code being tested (function, component, or workflow)

**Attributes**:

- `type`: "function" | "component" | "workflow"
- `name`: string (function/component name)
- `filePath`: string (source file path)
- `signature`: string (function signature if applicable)

**Relationships**:

- Tested by TestCase entities
- Covered by CoverageData

**Examples**:

- `toggleSquiggles()` function
- `setStatus()` function
- Extension activation workflow
- Command execution workflow

---

### Mock VSCode API

**Description**: Simulated VSCode API objects for unit testing

**Attributes**:

- `type`: "workspace" | "window" | "commands" | "StatusBarItem" | etc.
- `methods`: MockMethod[]
- `properties`: MockProperty[]
- `behavior`: "stub" | "spy" | "mock"

**Relationships**:

- Used by unit TestCase entities
- Replaces real VSCode API in tests

**Validation Rules**:

- Must match VSCode API interface
- Methods must be stubbed with Sinon
- Properties must be mockable

---

### Test Report

**Description**: Output showing test execution results

**Attributes**:

- `timestamp`: Date
- `totalTests`: number
- `passedTests`: number
- `failedTests`: number
- `skippedTests`: number
- `duration`: number (milliseconds)
- `results`: TestResult[]
- `format`: "terminal" | "json"

**Relationships**:

- Generated by TestSuite execution
- Contains TestResult entities

**Validation Rules**:

- Must include all test results
- Duration must be accurate
- Format must match spec requirement (terminal)

---

### Coverage Data

**Description**: Measurement of code execution during test runs

**Attributes**:

- `filePath`: string
- `lineCoverage`: number (percentage)
- `branchCoverage`: number (percentage)
- `functionCoverage`: number (percentage)
- `coveredLines`: number[]
- `uncoveredLines`: number[]
- `threshold`: number (80% default)

**Relationships**:

- Measures TestTarget coverage
- Part of CoverageReport

**Validation Rules**:

- Percentages must be 0-100
- Threshold warning at 80% (does not fail build)
- Must identify uncovered code paths

---

### Coverage Report

**Description**: Output showing which code is covered by tests

**Attributes**:

- `timestamp`: Date
- `overallCoverage`: CoverageData
- `fileCoverage`: CoverageData[] (per file)
- `format`: "terminal" (per spec clarification)
- `threshold`: number (80%)
- `warnings`: string[] (if below threshold)

**Relationships**:

- Contains CoverageData entities
- Generated by coverage tool (c8)

**Validation Rules**:

- Must show line, branch, and function coverage
- Must display per-file and overall percentages
- Must warn (not fail) if below threshold

---

## Test Organization Structure

```
src/test/
├── unit/                    # Unit tests (mocked VSCode APIs)
│   ├── toggleSquiggles.test.ts
│   ├── setStatus.test.ts
│   └── colorLogic.test.ts
├── integration/             # Integration tests (real VSCode APIs)
│   ├── activation.test.ts
│   ├── command.test.ts
│   └── configuration.test.ts
└── e2e/                     # End-to-end tests (Extension Development Host)
    ├── commandPalette.test.ts
    └── statusBar.test.ts
```

## State Transitions

### Test Execution Flow

```
Test Suite Created
    ↓
Test Cases Defined
    ↓
Setup Phase (if needed)
    ↓
Test Execution
    ↓
Assertions Verified
    ↓
Teardown Phase (if needed)
    ↓
Test Result Recorded
    ↓
Test Report Generated
```

### Coverage Measurement Flow

```
Tests Execute
    ↓
Code Instrumentation (c8)
    ↓
Coverage Data Collected
    ↓
Coverage Report Generated
    ↓
Threshold Check (80%)
    ↓
Warning Displayed (if below threshold)
```

## Validation Rules Summary

1. **Test Files**: Must be named `*.test.ts` and located in appropriate subdirectory
2. **Test Functions**: Must use Mocha `describe()` and `it()` structure
3. **Coverage Threshold**: 80% for core extension logic (`src/extension.ts`)
4. **Coverage Format**: Terminal output only (per spec clarification)
5. **Test Execution**: All test types must run in CI/CD environments
6. **Mock APIs**: Must use Sinon for VSCode API mocking in unit tests
